- name: Stop VM
  import_role:
    name: guest_provision
    tasks_from: shutdown.yaml

- block:
    - name: Remove existing vm
      community.libvirt.virt:
        command: undefine
        name: "{{ vm.metadata.name }}"
        uri: "{{ vm.metadata.connection }}"
        # Note: This may be required on some VM since this parameter feature force undefine of nvram, bios, etc ...
        # Will be added on version > 1.2, see https://github.com/ansible-collections/community.libvirt/pull/136
        force: true
  rescue:
    - name: Remove existing vm - fallback
      shell: 
        cmd: >-
          virsh
          --connect {{  vm.metadata.connection | quote }}
          undefine
          --domain {{ vm.metadata.name | quote }}
          --nvram

