
- block:
    - import_tasks:
        file: alpine_generic.yaml
  vars:
    # alpine_branch: v3.16
    # alpine_version: v3.16.1
    alpine_branch: v3.18
    # latest version
  
- vars:
    replaced_task:
      callback: callbacks/sources/extend_and_convert.yaml
      src: "{{ vm.metadata.sources[0].before_provision[2].src }}"
      dest: "{{ vm.metadata.sources[0].before_provision[2].dest }}"
      from_format: raw
      to_format: qcow2
      partition_number: 2
      size: 1G
  block:

    - name: Add new task to imported definition
      set_fact:
        vm: "{{ vm | combine(vm_override, recursive=true ) }}"
      vars:
        vm_override:
#          metadata:
#            sources:
#              - before_provision: "{{ vm.metadata.sources[0].before_provision[:2] + [ replaced_task ] + vm.metadata.sources[0].before_provision[3:] }}"
#                on_provision: "{{ vm.metadata.sources[0].on_provision }}"
          ram: "{{ [ ( ansible_memfree_mb / 2 ) | int, 512 ] | max }}"
          vcpus: "{{ [ ( ansible_processor_vcpus / 2 ) | int, 1] | max }}"
