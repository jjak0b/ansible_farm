

- name: Check if KVM dev is available
  stat:
    path: /dev/kvm
  register: resource_kvm

- name: Setup user groups
  become: yes
  block:

    - name: Add become user to libvirt_group and eventually kvm groups
      user:
        name: "{{ ansible_become_user }}"
        groups:
          - libvirt
          - &kvm_group "{{ resource_kvm.stat.exists | ternary('kvm', omit ) }}"
        state: present

    - name: Add become user to hypervisor_group and eventually kvm groups
      user:
        name: "{{ ansible_user }}"
        groups:
          - *kvm_group
#         - libvirt-qemu
        state: present

- name: Setup storage location for both system and session
  include_role: 
    name: stackhpc.libvirt-host
    tasks_from: pools
  loop:
    - uri: qemu:///system
      path: /var/lib/libvirt/images/
    - uri: qemu:///session
      path: "{{ ansible_env.HOME }}/.local/share/libvirt/images/"
  loop_control:
    loop_var: storage
  vars:
    ansible_become: "{{ storage.uri == 'qemu:///system' }}"
    libvirt_host_uri: "{{ storage.uri }}"
    libvirt_host_pools:
      - name: default
        type: dir
        capacity: 5368709120
        path: "{{ storage.path }}"
        mode: 755
