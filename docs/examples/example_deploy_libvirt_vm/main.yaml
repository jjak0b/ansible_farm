---

- name: Init VM on Hypervisor
  hosts: hypervisors
  gather_facts: yes
  roles:
    - parse_vms_definitions
  
  tasks:  

    - name: init VM connection
      loop: "{{ virtual_machines }}"

      include_role:
        name: init_vm_connection
      
      loop_control:
        loop_var: vm

- name: VM provisioning on Hypervisor host
  hosts: vms
  gather_facts: no
  serial: 1
  tasks:

    - block:
        - name: gather min facts of hypervisor host since some definitions require to use them
          setup:
            gather_subset: 
            - '!all, user'
          
        - debug:
            msg: "After: {{ ansible_user }}, {{ ansible_password }}, {{ ansible_become_user }}, {{ ansible_become_password }}"
        
        - name: "start KVM Provision role for '{{ vm.metadata.name }}'"
          include_role: 
            name: kvm_provision

      delegate_to: "{{ kvm_host }}"
      tags:
        - kvm_provision
    
    - block:
        - debug:
            var: vm

        - name: "Start VM provisioning of '{{ vm.metadata.name }}' "
          include_role: 
            name: guest_provision
          vars:
            allowed_phases:
              - startup
              - restore init
              - create init
              - restore clean
              - create clean
              - dependencies
              - init
              - main
              - terminate
              - shutdown

