# minimal debian sid platform where sha512 checksum is fetched with remote
# Note: this platform require a preprocessing since require to run 'ssh-keygen -A'  to allow ssh service to start
---

- name: Defining platform with usermode networking
  vars:
    vm_name: "VM {{ vm.metadata.platform_name }}_{{ vm.metadata.target_name }}"
    uri_base: "http://cdimage.debian.org/cdimage/cloud/sid/daily/latest"
    image_name: "debian-sid-nocloud-{{ vm.metadata.target_name }}-daily"
  block:
    - name: Fetch sha512 list
      uri:
        url: "{{ uri_base }}/SHA512SUMS"
        return_content: yes
        body_format: raw
      register: sha_fetch_result
      ignore_errors: yes
    
    - name: Define platform definition
      vars:
        sha_line_pattern: "(?P<sha>[0-9a-fA-F]+)(\\s+){{ image_name }}.qcow2"
      set_fact:
        vm:
          metadata:
            auth:
              become_user: "root"
              become_password: ""
              become_method: su
              user: "root"
              password: ""
            callbacks:
              sources:
                - before_provision:
                  - callbacks/sources/fetch_and_unarchive.yaml
            sources:
              - uri: "{{ uri_base }}/{{ image_name }}.qcow2"
                resource_name: "{{ image_name }}.qcow2"
                checksum_uri: null
                checksum_type: "sha512"
                checksum_value: "{{ sha_fetch_result is succeeded | ternary( sha_fetch_result.content | regex_search( sha_line_pattern, '\\g<sha>' ) | first, null ) }}"
                asset_name: &image_file_name "{{ image_name }}.qcow2"
          vcpus: 2
          ram: 2048
          disks:
            - type: "qcow2"
              devname: "hda"
              src: *image_file_name
